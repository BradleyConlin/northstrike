name: ci-smoke
on:
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
  smoke:
  if: ${{ github.event_name == "push" && github.ref == "refs/heads/main" }}
  smoke:  if: ${{ github.event_name != "pull_request" }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: Git LFS pull
        run: |
          git lfs install
          git lfs pull
      - name: Setup Python
        uses: actions/setup-python@v5
        - run: |
            python -m pip install -U pip
            pip install onnx onnxruntime numpy pyyaml
            pip install -r requirements.txt || true
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements/ci.txt
      - name: ONNX contracts + perf gates
        if: ${{ github.event_name == "push" && github.ref == "refs/heads/main" }}
        if: ${{ github.event_name == "push" && github.ref == "refs/heads/main" }}
        if: ${{ github.event_name != "pull_request" }}
        run: |
          python scripts/inference/check_onnx_contracts.py --config docs/perf/budgets.yaml --outdir artifacts/perf
          python scripts/inference/profile_onnx.py --config docs/perf/budgets.yaml --outdir artifacts/perf --check
          python scripts/inference/verify_manifest_hashes.py --manifest deploy/models/manifest.json --check
      - name: Pytest smoke
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install pytest
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install pytest
          pytest -q training/tests/inference -k "smoke or regress"
      - name: E2E tick snapshot
        run: |
          python scripts/inference/e2e_tick.py --out artifacts/perf/e2e_tick.json
      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-and-smoke
          path: |
            artifacts/perf/**
            deploy/models/manifest.json
